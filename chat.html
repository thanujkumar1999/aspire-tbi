<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ASPIRE TBI Chat</title>
  <style>
    body {
      font-family: 'Segoe UI', sans-serif;
      background: #ece5dd;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
    }
    h2 {
      background: #075e54;
      color: white;
      padding: 15px 20px;
      margin: 0;
      font-size: 1.5rem;
      text-align: center;
    }
    #chatBox {
      flex-grow: 1;
      padding: 10px;
      background: #dcdcdc;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 10px;
    }
    .message {
      max-width: 70%;
      padding: 10px 14px;
      border-radius: 7.5px;
      font-size: 14px;
      position: relative;
      box-shadow: 0 1px 0.5px rgba(0,0,0,0.13);
      word-wrap: break-word;
    }
    .message.self {
      background: #25d366;
      color: white;
      align-self: flex-end;
      border-top-right-radius: 0;
    }
    .message.other {
      background: #ffffff;
      color: #303030;
      align-self: flex-start;
      border-top-left-radius: 0;
    }
    .timestamp {
      font-size: 10px;
      opacity: 0.6;
      margin-top: 4px;
      text-align: right;
    }
    .input-container {
      background: #f0f0f0;
      padding: 10px 15px;
      display: flex;
      gap: 10px;
    }
    #messageInput {
      flex-grow: 1;
      border-radius: 25px;
      border: none;
      padding: 10px 20px;
      font-size: 15px;
      outline: none;
      box-shadow: inset 0 0 5px rgba(0,0,0,0.1);
    }
    #sendBtn {
      background: #25d366;
      border: none;
      border-radius: 50%;
      width: 42px;
      height: 42px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
    }
    #sendBtn svg {
      width: 20px;
      height: 20px;
      fill: white;
    }
    @media (max-width: 480px) {
      #chatBox {
        max-height: calc(100vh - 130px);
      }
    }
  </style>
</head>
<body>
  <h2>ASPIRE TBI Chat</h2>
  <div id="chatBox" role="log" aria-live="polite" aria-relevant="additions"></div>

  <div class="input-container">
    <input type="text" id="messageInput" placeholder="Type a message..." />
    <button id="sendBtn" aria-label="Send message" disabled>
      <svg viewBox="0 0 24 24">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      onChildChanged,
      onChildRemoved,
      update,
      remove
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlZZ79I_UCaTwV4KHo67Rauv99epa_VHc",
      authDomain: "aspire-tbi.firebaseapp.com",
      databaseURL: "https://aspire-tbi-default-rtdb.firebaseio.com",
      projectId: "aspire-tbi",
      storageBucket: "aspire-tbi.appspot.com",
      messagingSenderId: "9906395381",
      appId: "1:9906395381:web:546de5f0f6234703144dbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "chat");

    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    // For demonstration: generate a random senderId for this client
    const senderId = "user_" + Math.random().toString(36).substring(2, 10);

    messageInput.addEventListener("input", () => {
      sendBtn.disabled = messageInput.value.trim() === "";
    });

    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/\n/g, "<br>");
    }

    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      const msgObj = {
        message: text,
        timestamp: Date.now(),
        senderId: senderId
      };

      push(chatRef, msgObj);
      messageInput.value = "";
      sendBtn.disabled = true;
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    function addMessage(msg) {
      const div = document.createElement("div");
      const isSelf = msg.senderId === senderId;
      div.classList.add("message", isSelf ? "self" : "other");
      div.dataset.id = msg.id;

      let html = `<div class="text">${escapeHtml(msg.message)}</div>`;
      html += `<div class="timestamp">${formatTime(msg.timestamp)}</div>`;
      div.innerHTML = html;

      chatBox.appendChild(div);
      chatBox.scrollTop = chatBox.scrollHeight;
    }

    onChildAdded(chatRef, (snapshot) => {
      const msg = snapshot.val();
      msg.id = snapshot.key;
      addMessage(msg);
    });

    onChildChanged(chatRef, (snapshot) => {
      const msg = snapshot.val();
      msg.id = snapshot.key;
      const oldDiv = document.querySelector(`.message[data-id="${msg.id}"]`);
      if (oldDiv) oldDiv.remove();
      addMessage(msg);
    });

    onChildRemoved(chatRef, (snapshot) => {
      const msgId = snapshot.key;
      const div = document.querySelector(`.message[data-id="${msgId}"]`);
      if (div) {
        div.querySelector(".text").textContent = "üóëÔ∏è Message deleted";
        div.querySelector(".timestamp").textContent = "";
      }
    });
  </script>
</body>
</html>
