<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <title>ASPIRE TBI Chat</title>
  <style>
    /* Reset */
    * {
      box-sizing: border-box;
    }

    body {
      font-family: 'Segoe UI', Tahoma, Geneva, Verdana, sans-serif;
      background: #ece5dd;
      margin: 0;
      padding: 0;
      height: 100vh;
      display: flex;
      flex-direction: column;
      /* Safe area for notches on mobile */
      padding-bottom: env(safe-area-inset-bottom);
      padding-top: env(safe-area-inset-top);
    }
    h2 {
      background: #075e54;
      color: white;
      padding: 15px 20px;
      margin: 0;
      font-size: 1.5rem;
      text-align: center;
      position: sticky;
      top: 0;
      z-index: 10;
      box-shadow: 0 2px 5px rgba(0,0,0,0.15);
    }
    #chatBox {
      flex-grow: 1;
      padding: 10px 15px;
      background: #dcdcdc;
      overflow-y: auto;
      display: flex;
      flex-direction: column;
      gap: 12px;
      scroll-behavior: smooth;
    }
    .message {
      max-width: 80%;
      padding: 14px 18px;
      border-radius: 15px;
      font-size: 15px;
      position: relative;
      box-shadow: 0 1px 1px rgba(0,0,0,0.1);
      word-wrap: break-word;
      line-height: 1.3;
      animation: fadeInUp 0.3s ease forwards;
    }
    /* Different colors for self vs other */
    .message.self {
      background: #25d366;
      color: white;
      align-self: flex-end;
      border-top-right-radius: 4px;
      border-top-left-radius: 15px;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
    }
    .message.other {
      background: #ffffff;
      color: #303030;
      align-self: flex-start;
      border-top-left-radius: 4px;
      border-top-right-radius: 15px;
      border-bottom-left-radius: 15px;
      border-bottom-right-radius: 15px;
      box-shadow: 0 1px 5px rgba(0,0,0,0.1);
    }
    .timestamp {
      font-size: 10px;
      opacity: 0.5;
      margin-top: 6px;
      text-align: right;
      user-select: none;
    }
    .input-container {
      background: #f0f0f0;
      padding: 10px 15px;
      display: flex;
      gap: 10px;
      box-shadow: 0 -2px 5px rgba(0,0,0,0.1);
      position: sticky;
      bottom: 0;
      z-index: 10;
    }
    #messageInput {
      flex-grow: 1;
      border-radius: 25px;
      border: none;
      padding: 14px 20px;
      font-size: 16px;
      outline: none;
      box-shadow: inset 0 0 7px rgba(0,0,0,0.1);
      resize: none;
      max-height: 100px;
      line-height: 1.3;
    }
    #sendBtn {
      background: #25d366;
      border: none;
      border-radius: 50%;
      width: 46px;
      height: 46px;
      cursor: pointer;
      display: flex;
      align-items: center;
      justify-content: center;
      flex-shrink: 0;
      transition: background-color 0.3s ease;
    }
    #sendBtn:hover:not(:disabled) {
      background-color: #20b857;
    }
    #sendBtn:disabled {
      background-color: #a4d9b4;
      cursor: not-allowed;
    }
    #sendBtn svg {
      width: 22px;
      height: 22px;
      fill: white;
    }

    @media (max-width: 480px) {
      #chatBox {
        max-height: calc(100vh - 130px);
        padding: 8px 10px;
        gap: 10px;
      }
      .message {
        max-width: 90%;
        padding: 12px 16px;
        font-size: 14px;
      }
      #messageInput {
        font-size: 15px;
        padding: 12px 16px;
      }
      #sendBtn {
        width: 42px;
        height: 42px;
      }
    }

    /* Animation for messages */
    @keyframes fadeInUp {
      from {
        opacity: 0;
        transform: translateY(10px);
      }
      to {
        opacity: 1;
        transform: translateY(0);
      }
    }
  </style>
</head>
<body>
  <h2>ASPIRE TBI Chat</h2>
  <div id="chatBox" role="log" aria-live="polite" aria-relevant="additions"></div>

  <div class="input-container">
    <textarea id="messageInput" placeholder="Type a message..." rows="1" aria-label="Message input"></textarea>
    <button id="sendBtn" aria-label="Send message" disabled>
      <svg viewBox="0 0 24 24">
        <path d="M2.01 21L23 12 2.01 3 2 10l15 2-15 2z"/>
      </svg>
    </button>
  </div>

  <script type="module">
    import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
    import {
      getDatabase,
      ref,
      push,
      onChildAdded,
      onChildChanged,
      onChildRemoved
    } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-database.js";

    const firebaseConfig = {
      apiKey: "AIzaSyAlZZ79I_UCaTwV4KHo67Rauv99epa_VHc",
      authDomain: "aspire-tbi.firebaseapp.com",
      databaseURL: "https://aspire-tbi-default-rtdb.firebaseio.com",
      projectId: "aspire-tbi",
      storageBucket: "aspire-tbi.appspot.com",
      messagingSenderId: "9906395381",
      appId: "1:9906395381:web:546de5f0f6234703144dbc"
    };

    const app = initializeApp(firebaseConfig);
    const db = getDatabase(app);
    const chatRef = ref(db, "chat");

    const chatBox = document.getElementById("chatBox");
    const messageInput = document.getElementById("messageInput");
    const sendBtn = document.getElementById("sendBtn");

    // For demonstration: generate a random senderId for this client
    const senderId = "user_" + Math.random().toString(36).substring(2, 10);

    // Enable send button only if input is not empty
    messageInput.addEventListener("input", () => {
      sendBtn.disabled = messageInput.value.trim() === "";
      adjustTextareaHeight();
    });

    // Auto-grow textarea as user types
    function adjustTextareaHeight() {
      messageInput.style.height = "auto";
      messageInput.style.height = (messageInput.scrollHeight) + "px";
    }
    adjustTextareaHeight();

    // Escape HTML for security
    function escapeHtml(text) {
      return text
        .replace(/&/g, "&amp;")
        .replace(/</g, "&lt;")
        .replace(/>/g, "&gt;")
        .replace(/"/g, "&quot;")
        .replace(/'/g, "&#039;")
        .replace(/\n/g, "<br>");
    }

    // Format timestamp to local short time (HH:mm)
    function formatTime(ts) {
      return new Date(ts).toLocaleTimeString([], { hour: '2-digit', minute: '2-digit' });
    }

    // Send message to Firebase
    function sendMessage() {
      const text = messageInput.value.trim();
      if (!text) return;

      const msgObj = {
        message: text,
        timestamp: Date.now(),
        senderId: senderId
      };

      push(chatRef, msgObj);
      messageInput.value = "";
      sendBtn.disabled = true;
      adjustTextareaHeight();
    }

    sendBtn.addEventListener("click", sendMessage);
    messageInput.addEventListener("keydown", (e) => {
      if (e.key === "Enter" && !e.shiftKey) {
        e.preventDefault();
        sendMessage();
      }
    });

    // Add message to chatBox
    function addMessage(msg) {
      const div = document.createElement("div");
      const isSelf = msg.senderId === senderId;
      div.classList.add("message", isSelf ? "self" : "other");
      div.dataset.id = msg.id;

      let html = `<div class="text">${escapeHtml(msg.message)}</div>`;
      html += `<div class="timestamp">${formatTime(msg.timestamp)}</div>`;
      div.innerHTML = html;

      chatBox.appendChild(div);
      // Scroll smoothly to bottom when new message arrives
      chatBox.scrollTo({
        top: chatBox.scrollHeight,
        behavior: 'smooth'
      });
    }

    onChildAdded(chatRef, (snapshot) => {
      const msg = snapshot.val();
      msg.id = snapshot.key;
      addMessage(msg);
    });

    onChildChanged(chatRef, (snapshot) => {
      const msg = snapshot.val();
      msg.id = snapshot.key;
      const oldDiv = document.querySelector(`.message[data-id="${msg.id}"]`);
      if (oldDiv) oldDiv.remove();
      addMessage(msg);
    });

    onChildRemoved(chatRef, (snapshot) => {
      const msgId = snapshot.key;
      const div = document.querySelector(`.message[data-id="${msgId}"]`);
      if (div) {
        div.querySelector(".text").textContent = "üóëÔ∏è Message deleted";
        div.querySelector(".timestamp").textContent = "";
      }
    });
  </script>
</body>
</html>
