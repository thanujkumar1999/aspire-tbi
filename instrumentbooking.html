<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8" />
  <meta name="viewport" content="width=device-width, initial-scale=1.0" />
  <title>Instrument Booking</title>
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css">
  <style>
    * { box-sizing: border-box; font-family: 'Segoe UI', sans-serif; }
    body { margin: 0; padding: 20px; background: #f0f4ff; color: #333; }
    .app-container { max-width: 500px; margin: auto; background: #fff; padding: 25px; border-radius: 14px; box-shadow: 0 6px 14px rgba(0,0,0,0.15); }
    h2 { text-align: center; color: #004080; margin-bottom: 25px; }
    .form-group { margin-bottom: 15px; }
    .form-group label { font-weight: 500; display: block; margin-bottom: 5px; }
    .form-group input, .form-group select { width: 100%; padding: 10px; border-radius: 8px; border: 1px solid #ccc; }
    button { width: 100%; padding: 12px; background: #004080; color: #fff; border: none; border-radius: 8px; cursor: pointer; font-size: 16px; transition: 0.2s; }
    button:hover { background: #002a60; }
    .icons { text-align: center; margin-top: 25px; color: #004080; }
    .icons i { font-size: 28px; margin: 0 10px; }
    #bookingIdDisplay { margin-top: 15px; text-align: center; font-weight: 600; color: green; }
    #customTimeContainer { display: none; }
  </style>
</head>
<body>
  <div class="app-container">
    <h2><i class="fas fa-microscope"></i> Instrument Booking</h2>
    
    <div class="form-group">
      <select id="instrument" required>
        <option value="">-- Select Instrument --</option>
        <option>Lyophilizer</option>
        <option>HPLC-ANALYTICAL</option>
        <option>HPLC-PREP</option>
        <option>ORBITEK SHAKER</option>
        <option>SONICATOR</option>
        <option>CENTRIFUGE-HIGH SPEED</option>
        <option>K.F.TITRATOR</option>
        <option>UV-VIS-SPECTROPHOTOMETER</option>
        <option>LAMINAR FUMEHOOD</option>
        <option>INVERTED MICROSCOPE</option>
        <option>CO2 INCUBATOR</option>
        <option>GEL-DOC IMAGING</option>
        <option>PCR</option>
        <option>PH Meter</option>
      </select>
    </div>

    <div class="form-group"><input type="text" id="name" placeholder="Startup Name" required></div>
    <div class="form-group"><input type="text" id="username" placeholder="Employee Name" required></div>
    <div class="form-group"><input type="text" id="employeeid" placeholder="Employee ID" required></div>
    <div class="form-group"><input type="text" id="number" placeholder="Contact Number" required></div>

    <div class="form-group">
      <label>Start Date:</label>
      <input type="date" id="startDate" required />
    </div>

    <div class="form-group">
      <label>End Date (max 2 days):</label>
      <input type="date" id="endDate" required />
    </div>

    <div class="form-group">
      <label>Select Slot:</label>
      <select id="slot">
        <option value="">-- Select Slot --</option>
      </select>
    </div>

    <div class="form-group" id="customTimeContainer">
      <input type="text" id="customTime" placeholder="e.g., 09:00 AM - 04:00 PM" />
    </div>

    <button id="bookBtn"><i class="fas fa-calendar-check"></i> Book Instrument</button>
    <div id="bookingIdDisplay"></div>

    <div class="icons">
      <i class="fas fa-qrcode"></i>
      <i class="fas fa-id-card"></i>
      <i class="fas fa-wifi"></i>
      <i class="fas fa-microchip"></i>
    </div>
  </div>

  <script type="module">
import { initializeApp } from "https://www.gstatic.com/firebasejs/10.5.2/firebase-app.js";
import { 
  getFirestore, collection, addDoc, query, where, getDocs, serverTimestamp 
} from "https://www.gstatic.com/firebasejs/10.5.2/firebase-firestore.js";

const firebaseConfig = {
  apiKey: "AIzaSyAlZZ79I_UCaTwV4KHo67Rauv99epa_VHc",
  authDomain: "aspire-tbi.firebaseapp.com",
  projectId: "aspire-tbi",
  storageBucket: "aspire-tbi.appspot.com",
  messagingSenderId: "9906395381",
  appId: "1:9906395381:web:546de5f0f6234703144dbc"
};

const app = initializeApp(firebaseConfig);
const db = getFirestore(app);

const timeSlots = [
  "09:00 AM - 10:00 AM",
  "10:00 AM - 11:00 AM",
  "11:00 AM - 12:00 PM",
  "12:00 PM - 01:00 PM",
  "02:00 PM - 03:00 PM",
  "03:00 PM - 04:00 PM",
  "04:00 PM - 05:00 PM",
  "custom"
];

const slotSelect = document.getElementById("slot");
const customTimeContainer = document.getElementById("customTimeContainer");
const instrumentSelect = document.getElementById("instrument");
const startDateInput = document.getElementById("startDate");

function normalizeSlot(str) {
  return str.replace(/to/gi, "-").replace(/\s+/g, " ").trim();
}

function toMinutes(timeStr) {
  if (!timeStr) return 0;
  timeStr = timeStr.trim().toUpperCase();
  if (!timeStr.includes("AM") && !timeStr.includes("PM")) {
    const [hours, minutes] = timeStr.split(":").map(Number);
    return hours * 60 + (minutes || 0);
  }
  const [time, modifier] = timeStr.split(" ");
  let [hours, minutes] = time.split(":").map(Number);
  if (modifier === "PM" && hours !== 12) hours += 12;
  if (modifier === "AM" && hours === 12) hours = 0;
  return hours * 60 + (minutes || 0);
}

function isOverlap(slot1, slot2) {
  try {
    slot1 = normalizeSlot(slot1);
    slot2 = normalizeSlot(slot2);
    const [s1, e1] = slot1.split("-").map(s => s.trim());
    const [s2, e2] = slot2.split("-").map(s => s.trim());
    return toMinutes(s1) < toMinutes(e2) && toMinutes(s2) < toMinutes(e1);
  } catch {
    return false;
  }
}

async function fetchBookedSlots(instrument, date) {
  const q = query(collection(db, "bookings"), where("instrument", "==", instrument), where("date", "==", date));
  const snap = await getDocs(q);
  const bookedSlots = [];
  snap.forEach(doc => bookedSlots.push(normalizeSlot(doc.data().slot)));
  return bookedSlots;
}

async function updateSlotOptions() {
  slotSelect.innerHTML = '<option value="">-- Select Slot --</option>';
  const instrument = instrumentSelect.value.trim();
  const date = startDateInput.value;

  // No need to check if nothing is selected
  if (!instrument || !date) {
    timeSlots.forEach(slot => {
      const opt = document.createElement("option");
      opt.value = slot;
      opt.textContent = slot;
      slotSelect.appendChild(opt);
    });
    return;
  }

  const bookedSlots = await fetchBookedSlots(instrument, date);

  timeSlots.forEach(slot => {
    const option = document.createElement("option");
    option.value = slot;

    // Disable if overlaps
    const isFull = bookedSlots.some(b => isOverlap(b, slot));
    if (isFull) {
      option.disabled = true;
      option.textContent = `${slot} (Full)`;
      option.style.color = "red";
    } else {
      option.textContent = slot;
    }
    slotSelect.appendChild(option);
  });
}

slotSelect.addEventListener("change", e => {
  customTimeContainer.style.display = e.target.value === "custom" ? "block" : "none";
});

instrumentSelect.addEventListener("change", updateSlotOptions);
startDateInput.addEventListener("change", updateSlotOptions);

document.getElementById("bookBtn").addEventListener("click", bookInstrument);

async function bookInstrument() {
  const instrument = document.getElementById("instrument").value.trim();
  const name = document.getElementById("name").value.trim();
  const username = document.getElementById("username").value.trim();
  const employeeid = document.getElementById("employeeid").value.trim();
  const number = document.getElementById("number").value.trim();
  let slot = document.getElementById("slot").value;
  const customTime = document.getElementById("customTime").value.trim();
  const startDate = new Date(document.getElementById("startDate").value);
  const endDate = new Date(document.getElementById("endDate").value);

  if (!instrument || !name || !username || !employeeid || !number || !slot || isNaN(startDate) || isNaN(endDate))
    return alert("Please fill all fields.");

  if (slot === "custom") {
    if (!customTime) return alert("Please enter custom time range.");
    slot = normalizeSlot(customTime);
  }

  const diffDays = Math.floor((endDate - startDate) / (1000*60*60*24)) + 1;
  if (diffDays < 1 || diffDays > 2) return alert("You can only book up to 2 days.");

  const bookingIds = [];
  for (let i = 0; i < diffDays; i++) {
    const bookingDate = new Date(startDate);
    bookingDate.setDate(startDate.getDate() + i);
    const formattedDate = bookingDate.toISOString().split("T")[0];
    const bookedSlots = await fetchBookedSlots(instrument, formattedDate);

    const conflict = bookedSlots.some(b => isOverlap(b, slot));
    if (conflict) {
      alert(`⚠️ Slot already booked for ${formattedDate}`);
      return;
    }

    const bookingId = `BK_${instrument}_${formattedDate}_${Date.now()}`;
    bookingIds.push(bookingId);

    await addDoc(collection(db, "bookings"), {
      instrument, name, username, employeeid, number,
      date: formattedDate, slot, bookingId, timestamp: serverTimestamp()
    });
  }

  document.getElementById("bookingIdDisplay").innerText = 
    `✅ Booking Successful! IDs: ${bookingIds.join(", ")}`;

  // Refresh slot list
  updateSlotOptions();
}

function setActiveDates() {
  const today = new Date(); today.setHours(0,0,0,0);
  const maxDate = new Date(today); maxDate.setDate(today.getDate() + 7);
  const formatDate = date => date.toISOString().split("T")[0];
  const endDateInput = document.getElementById("endDate");

  startDateInput.min = formatDate(today);
  startDateInput.max = formatDate(maxDate);
  endDateInput.min = formatDate(today);
  endDateInput.max = formatDate(maxDate);

  startDateInput.addEventListener("change", () => {
    const start = new Date(startDateInput.value);
    const maxEnd = new Date(start);
    maxEnd.setDate(start.getDate() + 1);
    endDateInput.min = formatDate(start);
    endDateInput.max = formatDate(maxEnd > maxDate ? maxDate : maxEnd);
    if (new Date(endDateInput.value) < start) {
      endDateInput.value = formatDate(start);
    }
  });
}

setActiveDates();
updateSlotOptions();
</script>

</body>
</html>
